---
deployment:
  tasks:
    # Установка Node.js окружения
    - export DEPLOYPATH=/home/intentionb/public_html/
    - export NODE_VERSION=18
    - export PATH=/opt/cpanel/ea-nodejs18/bin:/opt/cpanel/node/bin:$PATH

    # Копируем файлы в директорию развертывания
    - /bin/cp -R . $DEPLOYPATH

    # Переходим в директорию проекта
    - cd $DEPLOYPATH

    # Проверяем доступность Node.js и npm
    - which node
    - which npm
    - node --version
    - npm --version

    # Очищаем npm cache для избежания проблем
    - npm cache clean --force

    # Устанавливаем зависимости с увеличенным timeout
    - npm install --timeout=600000 --no-audit --no-fund

    # Собираем проект для продакшена
    - npm run build

    # Проверяем что папка dist создалась
    - ls -la dist/

    # Копируем собранные файлы в корень public_html
    - /bin/cp -R dist/* ./

    # Создаем .htaccess для SPA маршрутизации ПЕРЕД удалением файлов
    - echo "Options -MultiViews" > .htaccess
    - echo "RewriteEngine On" >> .htaccess
    - echo "RewriteCond %{REQUEST_FILENAME} !-f" >> .htaccess
    - echo "RewriteRule ^ index.html [QSA,L]" >> .htaccess

    # Удаляем ненужные файлы и папки после деплоя
    - rm -rf node_modules
    - rm -rf src
    - rm -rf dist
    - rm -f package.json
    - rm -f package-lock.json
    - rm -f vite.config.ts
    - rm -f tsconfig.json
    - rm -f tsconfig.app.json
    - rm -f tsconfig.node.json
    - rm -f tailwind.config.ts
    - rm -f postcss.config.js
    - rm -f eslint.config.mjs
    - rm -f components.json
    - rm -f bun.lockb
    - rm -f .cpanel.yml
